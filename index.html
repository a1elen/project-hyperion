<!DOCTYPE html>
<title>project-hyperion</title>

<style>
    canvas {
        outline: 1px solid white
    }

    body {
        background-color: rgb(43, 43, 43);
        text-align: center;
        margin-top: 50px;
        overscroll-behavior: contain;
    }
</style>

<canvas></canvas>
<script src = "js/game.js"></script>
<script src = "js/map.js"></script>
<script src = "js/tile.js"></script>
<script src = "js/monster.js"></script>
<script src = "js/util.js"></script>
<script src = "js/spell.js"></script>
<script>
    tileSize = 64;
    numTiles = 12;
    uiWidth = 4;
    level = 1;
    maxHp = 10;

    spritesheet = new Image();
    spritesheet.src = 'spritesheet.png';
    spritesheet.onload = showTitle;

    gameState = "loading";

    startingHp = 10;
    numLevels = 6;

    shakeAmount = 0;
    shakeX = 0;
    shakeY = 0;

    // touch controls VERY DIRTY CODE PLS FIX
    let touchstartX = 0;
    let touchendX = 0;
    let touchstartY = 0;    
    let touchendY = 0;
    let xDist = 0;
    let yDist = 0;


    function touchMove(x, y) {
        if (gameState == "title") {
                startGame();
            } else if (gameState == "dead") {
                showTitle();
            } else if (gameState == "running") {
                player.tryMove(x, y);
            }
    }

    function checkDirection() {
        xDist = Math.floor(Math.abs(touchstartX - touchendX));
        yDist = Math.floor(Math.abs(touchstartY - touchendY));

        if (xDist < 200 && yDist < 200) {
            //alert(xDist + " \ " + yDist + " is less than 200");
            return;
        }

        if (touchendX < touchstartX && xDist > 200 && yDist < 200) {
            // left
            touchMove(-1, 0);
            //alert(xDist + " \ " + yDist);
            return;
        }
        if (touchendX > touchstartX && xDist > 200 && yDist < 200) {
            // right
            touchMove(1, 0);
            //alert(xDist + " \ " + yDist);
            return;
        }
        if (touchendY < touchstartY && yDist > 200 && xDist < 200) {
            // up
            touchMove(0, -1);
            //alert(xDist + " \ " + yDist);
            return;
        }
        if (touchendY > touchstartY && yDist > 200 && xDist < 200) {
            // down
            touchMove(0, 1);
            //alert(xDist + " \ " + yDist);
            return;
        }
    }

    document.addEventListener('touchstart', e => {
        touchstartX = e.changedTouches[0].screenX;
        touchstartY = e.changedTouches[0].screenY;
        e.preventDefault();
    })

    document.addEventListener('touchend', e => {
        touchendX = e.changedTouches[0].screenX;
        touchendY = e.changedTouches[0].screenY;
        checkDirection()
        e.preventDefault();
    })


    document.querySelector("html").onkeypress = function(e) {
        if (gameState == "title") {
            startGame();
        } else if (gameState == "dead") {
            showTitle();
        } else if (gameState == "running") {
            // Four-side movement
            if (e.key == "w" || e.key == "8") player.tryMove(0, -1);
            if (e.key == "s" || e.key == "2") player.tryMove(0, 1);
            if (e.key == "a" || e.key == "4") player.tryMove(-1, 0);
            if (e.key == "d" || e.key == "6") player.tryMove(1, 0);

            // Diagonal Movement
            if (e.key == "9") player.tryMove(1, -1);
            if (e.key == "3") player.tryMove(1, 1);
            if (e.key == "1") player.tryMove(-1, 1);
            if (e.key == "7") player.tryMove(-1, -1);

            if (e.key == "5") tick();

            if (e.key == "0") gameState = "spells";

        } else if (gameState = "spells") {
            if (e.key >= 1 && e.key <= 9) player.castSpell(e.key-1);

            if (e.key == "0") gameState = "running";
        }
    }

    setInterval(draw, 15);

    setupCanvas();

    initSounds();
</script>